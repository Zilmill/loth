<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>SEA3D webgl</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link href="webdemo/css/shader.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="container" class="unselectable"></div>
<div id="title"  class="unselectable"> ... </div>
<div id="options" class="unselectable">
    <div id="pinBtn" class="unselectable"></div>
	<div id="optionsContent" class="unselectable">
	<div class="block">
			<h2>SEA3D model</h2>
			<p class="input"><span id="scaletxt">Scale : 1</span> <input type="range" min="1" max="20" value="1" id="scaleValueInput"/></p>
			<ul class="list" id="modelList">
			    <li><a href="#" class="button active" data-value="dice">Dice</a></li>
				<li><a href="#" class="button" data-value="gauntlet">Gauntlet</a></li>
				<li><a href="#" class="button" data-value="drum">Drum</a></li>
				<li><a href="#" class="button" data-value="column">Column</a></li>
				<li><a href="#" class="button" data-value="gyro">Gyro</a></li>
				<li><a href="#" class="button" data-value="youbot">YouBot</a></li>
				<li><a href="#" class="button" data-value="body">Body</a></li>
				<li><a href="#" class="button" data-value="head">Head</a></li>
				<li><a href="#" class="button" data-value="onkba">Onkba</a></li>
				<li><a href="#" class="button" data-value="vision">Vision</a></li>
				<li><a href="#" class="button" data-value="dragon">Dragon</a></li>
				<li><a href="#" class="button" data-value="panthere">Panthere</a></li>
			</ul>
		</div>
		<div class="block">
			<h2>Material map</h2>
			<!--<p class="input"><span id="blurtxt">Blur : 1</span> <input type="range" min="1" max="50" value="1" id="blurValueInput"/></p>-->
			<p class="input"><span id="linetxt">Line : 10</span> <input type="range" min="1" max="100" value="10" id="lineValueInput"/></p>
			<p class="input"><span id="alphatxt">Alpha : 50</span> <input type="range" min="0" max="100" value="50" id="alphaValueInput"/></p>
			<div id="map">
				<div id="mh0"></div>
				<div id="mh1"></div>
				<div id="mh2"></div>
				<div id="mh3"></div>
			</div>
			<div id="grad0"></div>
			<div id="grad1"></div>
			<div id="grad2"></div>
				
			
			<ul class="list" id="materialList">
			</ul>
		</div>
		<div class="block">
			<h2>Normal map</h2>
			<ul class="list" id="normalList">
			</ul>
		</div>
		<div class="block">
			<h2>Normal scale</h2>
			<p class="input"><span>Intensity:</span> <input type="range" min="0" max="200" value="50" id="normalValueInput"/></p>
			<p class="input"><span>Repeat:</span> <input type="range" min="1" max="10" value="1" id="normalRepeatInput"/></p>
		</div>
		<div class="block">
			<h2>Rim lighting</h2>
			<p class="input"><span>Intensity:</span> <input type="range" min="0" max="100" value="0" id="rimValueInput"/></p>		
			<p class="input"><span>Power:</span> <input type="range" min="0 " max="100" value="40" id="rimPowerValueInput"/></p>	
		</div>
		<div class="block">
			<h2>Render options</h2>
			<p>
			<a href="#" id="screenBlendingBtn" class="button">Screen Blending</a> 
			<a href="#" id="antialiasingButton" class="button">Antialiasing</a>
			<a href="#" id="fullscreenBtn" class="button">Fullscreen</a>
			</p>
		</div>
		<div class="block">
		<h2>Credits</h2><p>
		    Code and model by <a href="http://3dflashlo.wordpress.com/" rel="external">Loth</a><br>
		    Shader by <a href="http://www.twitter.com/thespite" rel="external">Jaume SÃ¡nchez</a><br>
		    3d engine THREE.JS by Mr Doob<br>
		    3d format SEA3D <br></p>
		</div>
	</div>
</div>
<div id="loader" class="unselectable"><img src="webdemo/assets/ajax-loader.gif" alt="Loading..." id="loaderImg"></div>

<script src="webdemo/js/three.min.js"></script>
<script src="webdemo/js/stats.min.js"></script>
<script src="webdemo/js/effects/spherical.js"></script>
<script src="webdemo/js/Detector.js"></script>
<script src="webdemo/js/ImprovedNoise.js"></script>

<script src="webdemo/js/loaders/sea3d/SEA3D.js"></script>
<script src="webdemo/js/loaders/sea3d/SEA3DLoader.js"></script>
<script src="webdemo/js/loaders/sea3d/SEA3DDeflate.js"></script>
<script src="webdemo/js/loaders/sea3d/SEA3DLZMA.js"></script>

<script src="webdemo/js/CameraLoth.js"></script>
<script src="webdemo/js/tweenLite.js"></script>
<script src="webdemo/js/FastBlur.js"></script>
<script src="webdemo/js/ShaderInterface.js"></script>

<script>'use strict'
var container=document.getElementById('container');
var loader=document.getElementById('loader');
var currentModel="";
var presets=[];
var AssetsFolder = "webdemo/assets/";
var delta, clock;
var ambient,spotLight;
var renderer,composer, scene,camera,mesh,fov=120,nfov=45,sphereMaterial,material,materialAnim,start=Date.now(), content, cam;
var renderNoise=.04,nRenderNoise=.04,CSSAntialias=false,useScreenBlend=false, optionsPinned=false;
var cubeCamera, envSphere;
var textureCube, envMaterial;
var materialTrans;
var materialMorph;
var noise=new ImprovedNoise();
var MaxAnistropy;

if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

function init(){
	showLoader(true);
    initInterface();

    clock = new THREE.Clock();

	renderer=new THREE.WebGLRenderer({antialias:true});//,preserveDrawingBuffer:true});
    renderer.physicallyBasedShading = true;
	renderer.gammaOutput = true;
	renderer.gammaInput = true;

	MaxAnistropy = renderer.getMaxAnisotropy();
	container.appendChild(renderer.domElement);
	scene = new THREE.Scene();
	cam = new CameraLoth(container);

	initLight();
	initMaterial();

	// background sphere
	var sphere=new THREE.Mesh(new THREE.IcosahedronGeometry(10000,1),sphereMaterial);
	sphere.scale.set(-1,1,1);
	scene.add(sphere);

	// imported object container
	content = new THREE.Object3D();
	scene.add(content);

	window.addEventListener('resize',onWindowResize,false);
	onWindowResize();

	onThreeChangeView(40, 60, 100);
	loadSphere();
	render();
}

function initLight(){
	ambient = new THREE.AmbientLight( 0xFFFFFF);
	scene.add( ambient );

	spotLight = new THREE.SpotLight( 0xffffff );
	spotLight.intensity = 1;
	spotLight.position.set(100,200,50);
	scene.add( spotLight );
}

function initMaterial(){
	/*var tx = new THREE.Texture(canvasSphere[1]);
	tx.anisotropy = MaxAnistropy;
	tx.needsUpdate = true;*/

	material=new THREE.ShaderMaterial({
		uniforms:{
			tNormal:{type:'t', value:txt},
			tMatCap:{ type:'t', value:txt},
			time:{ type:'f',value:0},
			bump:{type:'f',value:0},
			noise:{ type:'f',value:.04},
			repeat:{type:'v2',value:new THREE.Vector2(1,1)},
			useNormal:{ type:'f',value:0},
			useRim:{ type:'f',value:0},
			rimPower:{ type:'f',value:2},
			useScreen:{ type:'f',value:0},
			normalScale:{ type:'f',value:.5},
			normalRepeat:{ type:'f',value:1}
		},
		vertexShader:sphere_vertexShader,
		fragmentShader:sphere_fragmentShader,
		wrapping:THREE.ClampToEdgeWrapping,
		shading:THREE.SmoothShading
	});
	material.uniforms.tMatCap.value.wrapS=material.uniforms.tMatCap.value.wrapT=THREE.ClampToEdgeWrapping;
	material.uniforms.tNormal.value.wrapS=material.uniforms.tNormal.value.wrapT=THREE.RepeatWrapping;


	envMaterial = new THREE.MeshBasicMaterial( {map: material.uniforms.tMatCap.value} );

	materialAnim =  new THREE.MeshPhongMaterial( {
		color: 0xffFFFF, 
		ambient: 0xFFFFFF, 
		shininess:1, 
		specular:0xffFFFF,
		reflectivity:1,  
		envMap:txt, 
		//lightMap:THREE.ImageUtils.loadTexture(AssetsFolder+'matcap/jeepster_skinmat2.jpg', THREE.SphericalReflectionMapping()),//txt,
		//refractionRatio:0.98,
	    combine: THREE.MixOperation,
		skinning:true,
		normalMap:material.uniforms.tNormal.value,
		normalScale:{x:0,y:0}//,
		//wrapping:THREE.ClampToEdgeWrapping,
		//shading:THREE.SmoothShading//,
		//metal:true
	} ) 

	materialAnim.normalMap.repeat.set( 1, 1 );
	materialAnim.normalMap.wrapS=materialAnim.normalMap.wrapT=THREE.RepeatWrapping;

	materialMorph =  new THREE.MeshPhongMaterial( {
		color: 0xffFFFF, 
		ambient: 0xFFFFFF, 
		shininess:1, 
		specular:0xffFFFF,
		reflectivity:1,  
		envMap:txt, 
		refractionRatio:0.98,
	    combine: THREE.MixOperation,
		skinning:false,
		morphTargets: true,
		//morphNormals: true,
		normalMap:material.uniforms.tNormal.value,
		normalScale:{x:0,y:0},
		wrapping:THREE.ClampToEdgeWrapping,
		shading:THREE.SmoothShading,
		metal:true
	} ) 

	materialMorph.normalMap.repeat.set( 1, 1 );
	materialMorph.normalMap.wrapS=materialAnim.normalMap.wrapT=THREE.RepeatWrapping;

	materialTrans =  new THREE.MeshPhongMaterial( {
		//color: 0x000000, 
		ambient: 0xFFFFFF, 
		shininess:50, 
		specular:0xffFFFF,
		reflectivity:1,  
		envMap:txt, 
	    combine: THREE.MixOperation,
		normalMap:material.uniforms.tNormal.value,
		normalScale:{x:0,y:0},
		wrapping:THREE.ClampToEdgeWrapping,
		shading:THREE.SmoothShading,
		transparent:true,
		opacity:0.6
	} ) 
	materialTrans.normalMap.repeat.set( 1, 1 );
	materialTrans.normalMap.wrapS=materialAnim.normalMap.wrapT=THREE.RepeatWrapping;

	sphereMaterial=new THREE.ShaderMaterial({
		uniforms:{
			resolution:{ type:'v2',value:new THREE.Vector2(0,0)},
			noise:{ type:'f',value:.04}
		},
		vertexShader:sphere_vs,
		fragmentShader:sphere_fs,
		side:THREE.BackSide
	});
}

function showLoader(show){
	if(show)loader.style.visibility = 'visible';
	else loader.style.visibility = 'hidden';
}

function loadSphere(){
	var loader = new THREE.SEA3D( true );
	loader.onComplete = function( e ) {
		var geo = loader.meshes[0].geometry;
		envSphere = new THREE.Mesh(geo, envMaterial);
		scene.add(envSphere);
		cubeCamera = new THREE.CubeCamera( 0.1, 1.5, 128 );
		cubeCamera.scale.set(-1,1,1);
		cubeCamera.lookAt( new THREE.Vector3(0,0,5))
		scene.add( cubeCamera );
		cubeCamera.updateCubeMap( renderer, scene );
		materialAnim.envMap = cubeCamera.renderTarget;
		materialTrans.envMap = cubeCamera.renderTarget;

		loadSeaFile(AssetsFolder + "models/dice.sea", 20);
	}
	loader.load( AssetsFolder + "models/sphere2.sea" );
}

var meshs = [];
var animMeshs = [];
var meshPositions = [];

function loadSeaFile(file, s){
	showLoader(true);
	clearContent();
	meshs = [];
	animMeshs = [];
	meshPositions = [];
	
	var loader = new THREE.SEA3D( true );

	loader.onComplete = function( e ) {
		showLoader(false);
		var i, j;
		var n=0;
		var linkList ="";
		for (i=0; i !== loader.meshes.length; i++){
			meshs[i] = loader.meshes[i];
			//meshs[i].geometry.computeVertexNormals();
			//meshs[i].geometry.verticesNeedUpdate=true;
			//meshs[i].geometry.normalsNeedUpdate=true;

			meshs[i].geometry.buffersNeedUpdate = true;
			meshs[i].geometry.uvsNeedUpdate=true;

			/*meshs[i].geometry.computeCentroids();
			meshs[i].geometry.computeFaceNormals();
			meshs[i].geometry.computeVertexNormals();
			meshs[i].geometry.computeMorphNormals();
			meshs[i].geometry.computeTangents();*/
	        
	        //meshs[i].geometry.computeBoundingBox();
			//meshBox[i] = meshs[i].geometry.boundingBox;
			
			// original position
			meshPositions[i] = [meshs[i].position.x, meshs[i].position.y, meshs[i].position.z];

			// linked Object
			if(meshs[i].children.length>0){
				for(j=0; j!== meshs[i].children.length; j++){
					meshs[i].children[j].name = "_"+meshs[i].children[j].name;
				}
			}
			

			// animation test
			if(meshs[i].bones){
				meshs[i].name = meshs[i].name+"_a";
				meshs[i].material = materialAnim;
				linkList+= meshs[i].name+"<br>";
				for(j=0;j!==meshs[i].animations.length;j++){
					linkList+="___"+meshs[i].animations[j].name+"<br>";

				}
				//meshs[i].JITCompile = false;
				//meshs[i].interpolationType = THREE.AnimationHandler.LINEAR;
				//animMeshs.push(meshs[i]);
				//if(meshs[i].currentAnimation)
				//	meshs[i].play(meshs[i].currentAnimation);
				//meshs[i].play('idle');
			} else {
				meshs[i].material = material;
				linkList+= meshs[i].name+"<br>";
			}

			
		}

		document.getElementById('title').innerHTML = linkList;

		for (i=0; i !== meshs.length; i++){
			if(meshs[i].name[0]!=="_"){
				if(currentModel!=="head"){
					meshs[i].scale.set(s,s,s);
					meshs[i].position.set(meshs[i].position.x*s,meshs[i].position.y*s,meshs[i].position.z*s);
					content.add(meshs[i]);
			    } else {
			    	if(meshs[i].name == "skin_hi"){
			    		meshs[i].material = materialMorph;
			    		meshs[i].setWeightByName("aah", 1);
			    	}
			    	if(meshs[i].name == "Fake_neck_a"){
			    		meshs[i].scale.set(s,s,s);
			    		meshs[i].position.set(meshs[i].position.x*s,meshs[i].position.y*s,meshs[i].position.z*s);
			    		content.add(meshs[i]);
			    	}
			    }
			}
		}
		/*var max=0;
		for (i=0; i !== meshBox.length; i++){
			if(meshBox[i].max.y)max = meshBox[i].max.y;
		}*/

		//document.getElementById('title').innerHTML = max*s*2;
		//onChangeDistance( max*s*2*100);
		sea3dSpecial(s);

	}
	loader.load( file );
}

function sea3dSpecial(size){
	var i;
	switch(currentModel){
		case'vision':
			var visionWheel = new THREE.Object3D();
			var visionSit = new THREE.Object3D();
			var visionSteering;
			for (i=0; i !== meshs.length; i++){
				if(meshs[i].name == "wheel" || meshs[i].name == "wheel_j1" || meshs[i].name == "wheel_j2"){content.remove(meshs[i]); visionWheel.add(meshs[i]);}
				if(meshs[i].name == "sitBase" || meshs[i].name == "sitColor" || meshs[i].name == "sitColor002"){content.remove(meshs[i]); visionSit.add(meshs[i]);}
				if(meshs[i].name == "steering")visionSteering = meshs[i];
				if(meshs[i].name == "glass_top" || meshs[i].name == "dooor_glass"|| meshs[i].name == "door_glass"|| meshs[i].name == "glass_wheel_window") meshs[i].material = materialTrans;
			}
			var sits = [];	
			for (i = 0; i < 4; i++) {
				sits[i] = visionSit.clone();
				content.add(sits[i]);
			}
			var px = 70*size, pz = 125*size;
			sits[0].position.set(-px, -2.2, 0);
			sits[1].position.set(-px, -2.2, pz);
			sits[2].position.set(px, -2.2, 0);
			sits[3].position.set(px, -2.2, pz);
			
			visionSteering.position.set(70*size, (123*size) -2.2, -96*size);
			// WHEELS
			var wheels = [];
			for (i = 0; i < 4; i++) {
				wheels[i] = visionWheel.clone();
				content.add(wheels[i]);
			}
			var wPos = new THREE.Vector3(138, 60, 237);
			wheels[0].position.set(-wPos.x * size, wPos.y * size, wPos.z * size);
			wheels[1].position.set(-wPos.x * size, wPos.y * size, -wPos.z * size);
			wheels[2].position.set(wPos.x * size, wPos.y * size, wPos.z * size);
			wheels[3].position.set(wPos.x * size, wPos.y * size, -wPos.z * size);
			wheels[2].scale.set(-1, -1, 1 );
			wheels[3].scale.set(-1, -1, 1 );
		break;
		case'youbot':
		    var wheels = [];
		    var joint = [];
		    for (i=0; i !== meshs.length; i++){
				if(meshs[i].name == "bot_wheel_R"){wheels[0]=meshs[i]; wheels[1]=meshs[i].clone(); content.add(wheels[1]);}
				if(meshs[i].name == "bot_wheel_L"){wheels[2]=meshs[i]; wheels[3]=meshs[i].clone(); content.add(wheels[3]);}
				if(meshs[i].name == "_arm_joint_1"){joint[1]=meshs[i];}
				if(meshs[i].name == "_arm_joint_2"){joint[2]=meshs[i];}
				if(meshs[i].name == "_arm_joint_3"){joint[3]=meshs[i];}
				if(meshs[i].name == "_arm_joint_4"){joint[4]=meshs[i];}
				if(meshs[i].name == "_arm_joint_5"){joint[5]=meshs[i];}

				//if(meshs[i].name == "rope_2_3_a"){joint[5]=meshs[i];}
				if(meshs[i].name == "rope_2_3_a"){content.remove(meshs[i]);}
				if(meshs[i].name == "rope_3_4_a"){content.remove(meshs[i]);}
			}
			wheels[0].position.set(-22.5, 5, -15.8);
			wheels[2].position.set(-22.5, 5, 15.8);
			wheels[1].position.set(22.5, 5, 15.8);
			wheels[3].position.set(22.5, 5, -15.8);
			joint[2].rotation.y = 45*ToRad;
			joint[3].rotation.y = 45*ToRad;
			joint[4].rotation.y = -45*ToRad;
		break;
	}
}

function scaleContent(n){
	if(content){
		var obj, i;
		for ( i=0; i !== meshs.length; i++ ) {
			if(meshs[i].name[0]!=="_"){
			    meshs[i].scale.set(n,n,n);
			    meshs[i].position.set(meshPositions[i][0]*n,meshPositions[i][1]*n,meshPositions[i][2]*n);
	        }
		}
	}
}

function clearContent(){
	if(content){
		var obj, i, j;
		for ( i = content.children.length - 1; i >= 0 ; i -- ) {
	    	obj = content.children[ i ];
	    	// remove animation
	    	if(obj.name[obj.name.length-1]=="a" && obj.name[obj.name.length-2]=="_"){
	    		for ( j = obj.animations.length - 1; j >= 0 ; j -- ){obj.animations[j].stop();}
	    	}
	        // remove children
	        if(obj.children.length > 0) for ( j = obj.children.length - 1; j >= 0 ; j -- ) {obj.remove(obj.children[j]);}
			content.remove(obj);
		}
	}
}

function setNoise(n){
	material.uniforms.noise.value=sphereMaterial.uniforms.noise.value=n;
}

function onWindowResize(){
	var s=CSSAntialias?2:1;
	setCameraSize(s*window.innerWidth, s*window.innerHeight);
	renderer.setSize(s*window.innerWidth,s*window.innerHeight);
	sphereMaterial.uniforms.resolution.value.set(s*window.innerWidth,s*window.innerHeight);
}

function render(){
	spotLight.position.copy(camera.position);
	spotLight.lookAt(center);

	delta = clock.getDelta();
	THREE.AnimationHandler.update( delta );

	renderNoise+=(nRenderNoise-renderNoise)*.2;
	setNoise(renderNoise);

	renderer.render(scene,camera);

	if(envSphere){
		envSphere.rotation.y = (-camPos.horizontal)*ToRad;
		envSphere.rotation.z = (-camPos.vertical-90)*ToRad;
		envSphere.visible = true;
		cubeCamera.updateCubeMap( renderer, scene );
		envSphere.visible = false;
	}
	requestAnimationFrame(render);
}

window.addEventListener('load',init);
</script>
</body>
</html>
