<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Three YouBot</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<meta property="og:title" content="Three Youbot - WebGL"/>
		<meta property="og:description" content="Robot simulation demo"/>
		<meta name="language" content="en-us" />
		<style>
			body {
				font-family: Monospace;
				font-size:11px;
				background-color: #000;
				color: #fff;
				margin: 0px;
				overflow: hidden;
				height: 100%;
			}
			#info {
				color: #fff;
				position: absolute;
				top: 10px;
				width: 300px;
				height: 300px;
				text-align: left;
				display:block;
				z-index: 100;
				margin-left:10px;
			}			
			#loading {
			    position: fixed;
			    top: 50%;
			    left: 50%;
			}
			#info a, .button { color: #999; font-weight: bold; text-decoration: underline; cursor: pointer }
		</style>
	</head>

	<body>		
		<div id="info"></div>
		<div id="loading"><img src="images/ajax-loader.gif" alt="Loading youbot robot"></div>
		<script src="js/three.min.js"></script>	
		<script src="js/tweenLite.min.js"></script>
		<script src="js/CameraLoth.js"></script>	
		<script src="js/loaders/sea3d/SEA3D.js"></script>
		<script src="js/loaders/sea3d/SEA3DLoader.js"></script>
		<script src="js/loaders/sea3d/SEA3DDeflate.js"></script>
		<script src="js/loaders/sea3d/SEA3DLZMA.js"></script>

		<script src="js/postprocessing/EffectComposer.js"></script>
		<script src="js/postprocessing/RenderPass.js"></script>
		<script src="js/postprocessing/ShaderPass.js"></script>
		<script src="js/postprocessing/MaskPass.js"></script> 
		<script src="js/shaders/CopyShader.js"></script>
		<script src="js/shaders/ColorCorrectionShader.js"></script>

		<script>								
			var container, info;
			var cam, scene, renderer, clock, loader, composer, renderPass, delta, sunLight;
			var ToRad = Math.PI / 180;
			// geometry
			var wheel_geo_r, wheel_geo_l;
			// mesh
			var wheels = [];
			var base, plate, arm_base, arm_joint_1;
			var youbot;

			window.onload = init;
			

			function init() {
				container = document.createElement( 'div' );
				container.style.position = "absolute";
				document.body.appendChild( container );
				
				clock = new THREE.Clock();

				// Scene
				scene = new THREE.Scene();
				scene.fog = new THREE.Fog( 0x121212 , 200, 1000 );
				cam = new CameraLoth();
				camera.aspect = window.innerWidth / (window.innerHeight-4);
				camera.updateProjectionMatrix();

				// Lights and shadow
				var ambient = new THREE.AmbientLight( 0x333333);
				scene.add( ambient );												
				
				var hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.3 );
				hemiLight.color.setHex( 0xfeffe6 );
				hemiLight.groundColor.setHex( 0x303030 );
				hemiLight.position.set( 0, 500, 0 );
				scene.add( hemiLight );

				sunLight = new THREE.DirectionalLight( 0xe6f3ff );
				sunLight.intensity = 0.5;
				sunLight.castShadow = true;

				sunLight.shadowCameraNear = 100;
				sunLight.shadowCameraFar = 500;
				
				sunLight.shadowMapBias = 0.01;
				sunLight.shadowMapDarkness = 0.3;
				sunLight.shadowMapWidth =1024;
				sunLight.shadowMapHeight =1024;

				var lightSize = 130;

				sunLight.shadowCameraLeft = -lightSize;
				sunLight.shadowCameraRight = lightSize;
				sunLight.shadowCameraTop = lightSize;
				sunLight.shadowCameraBottom = -lightSize;

				//sunLight.shadowCameraVisible = true;
				scene.add(sunLight);
				
				// Renderer
				renderer = new THREE.WebGLRenderer();				
				renderer.physicallyBasedShading = true;
				renderer.shadowMapEnabled = true;
				renderer.shadowMapSoft = true;
				renderer.setClearColor( 0x121212, 1 );
				renderer.setSize( window.innerWidth, window.innerHeight-4 );
				container.appendChild( renderer.domElement );
				
				// Renderer Composer
				composer = new THREE.EffectComposer( renderer );
				renderPass = new THREE.RenderPass( scene, camera );
				var copyPass = new THREE.ShaderPass( THREE.CopyShader );				
				composer.addPass( renderPass );
				//var vh = 1.6, vl = 1.2;
				var vh = 1.05, vl = 1.2;
				var colorCorrectionPass = new THREE.ShaderPass( THREE.ColorCorrectionShader );
				colorCorrectionPass.uniforms[ "powRGB" ].value = new THREE.Vector3( vh, vh, vh );
				colorCorrectionPass.uniforms[ "mulRGB" ].value = new THREE.Vector3( vl, vl, vl );
				composer.addPass( colorCorrectionPass );
				composer.addPass( copyPass );
				copyPass.renderToScreen = true;
				
				window.addEventListener( 'resize', onResize, false );
				
				// ground
				var geometry = new THREE.PlaneGeometry( 20000,20000 );
				var groundMap = new THREE.ImageUtils.loadTexture("images/ground.jpg");
				groundMap.repeat.set( 2000, 2000 );
				groundMap.wrapS = groundMap.wrapT = THREE.RepeatWrapping;
				var mat00 = new THREE.MeshPhongMaterial( { map:groundMap , shininess:20, specular:0x909090} );
				var plane = new THREE.Mesh( geometry, mat00 );
				plane.rotation.x = 90*ToRad;
				scene.add(plane);
				plane.receiveShadow = true;
				plane.castShadow = false;

				loadRobot();
			}

			function loadRobot() {
				var sea3dStandard = true;
				//var matBasic = new THREE.MeshPhongMaterial( { color: 0x333333, shininess:100, specular:0xffffff } );
				var matBasic = new THREE.MeshLambertMaterial( { color: 0x333333, shininess:100, specular:0xffffff } );

				if (sea3dStandard)
					camera.scale.set(-1, 1, 1);
				
				loader = new THREE.SEA3D( sea3dStandard );	
				
				loader.onComplete = function( e ) {
					for (var i=0; i !== loader.meshes.length; i++){
						loader.meshes[i].material = matBasic;
						if(loader.meshes[i].name === "base_frame" ) base = loader.meshes[i];
						if(loader.meshes[i].name === "bot_wheel_R" ) wheel_geo_r = loader.meshes[i].geometry;
						if(loader.meshes[i].name === "bot_wheel_L" ) wheel_geo_l = loader.meshes[i].geometry;
					}
					createRobot();
					document.getElementById('loading').style.visibility = 'hidden';
				};
				loader.load( 'models/youbot.sea' );
			}

			function createRobot() {
				var i;
				youbot = new THREE.Object3D();
				scene.add(youbot);
				// textures
				var textures = [];
				textures[0] = new THREE.ImageUtils.loadTexture("images/base.jpg");
				textures[1] = new THREE.ImageUtils.loadTexture("images/wheel.jpg");
				textures[2] = new THREE.ImageUtils.loadTexture("images/base_frame.jpg");
				textures[3] = new THREE.ImageUtils.loadTexture("images/joint1.jpg");
				textures[4] = new THREE.ImageUtils.loadTexture("images/plate.jpg");
				for(i = 0; i!== textures.length; i++){
					textures[i].repeat.set( 1, -1 );
				    textures[i].wrapS = textures[i].wrapT = THREE.RepeatWrapping;
				    textures[i].anisotropy = renderer.getMaxAnisotropy();
				}

				// material
				var shine = 10;
				var specular = 0x606060;
				var baseMaterial = new THREE.MeshPhongMaterial( { map: textures[0], shininess:shine, specular:specular } );
				var wheelMaterial = new THREE.MeshPhongMaterial( { map: textures[1], shininess:shine, specular:specular } );
				var armBaseMaterial = new THREE.MeshPhongMaterial( { map: textures[2], shininess:shine, specular:specular } );
				var joint1Material = new THREE.MeshPhongMaterial( { map: textures[3], shininess:shine, specular:specular } );
				var plateMaterial = new THREE.MeshPhongMaterial( { map: textures[4], shininess:shine, specular:specular } );

				/*var baseMaterial = new THREE.MeshLambertMaterial( { map: textures[0], shininess:100, specular:0x404040 } );
				var wheelMaterial = new THREE.MeshLambertMaterial( { map: textures[1], shininess:100, specular:0x404040 } );
				var armBaseMaterial = new THREE.MeshLambertMaterial( { map: textures[2], shininess:100, specular:0x404040 } );
				var joint1Material = new THREE.MeshLambertMaterial( { map: textures[3], shininess:100, specular:0x404040 } );
				var plateMaterial = new THREE.MeshLambertMaterial( { map: textures[4], shininess:100, specular:0x404040 } );*/

				// detect mesh
				var name;
				for(i = 0; i!== base.children.length; i++){
					name = base.children[i].name;
					if(name === "arm_base_frame") arm_base = base.children[i]
					if(name === "plate") plate = base.children[i]
				}
				arm_joint_1 = arm_base.children[0];

				// apply material
				base.material = baseMaterial;
				plate.material = plateMaterial;
				arm_base.material = armBaseMaterial;
				arm_joint_1.material = joint1Material;

				youbot.add( base );

				for(i=0; i!==4;i++){
					if(i===0 || i===2) wheels[i] = new THREE.Mesh( wheel_geo_r, wheelMaterial);
					else wheels[i] = new THREE.Mesh( wheel_geo_l, wheelMaterial);
					
					if(i===0) wheels[i].position.set(-22.5, 5, -15.8);
					if(i===1) wheels[i].position.set(-22.5, 5, 15.8);
					if(i===2) wheels[i].position.set(22.5, 5, 15.8);
					if(i===3) wheels[i].position.set(22.5, 5, -15.8);

					wheels[i].receiveShadow = true;
					wheels[i].castShadow = true;

					youbot.add( wheels[i] );
				}

				document.addEventListener( 'keydown', onKeyDown, false );
				document.addEventListener( 'keyup', onKeyUp, false );

				onThreeChangeView(40, 60, 150);

				animate();
			}

			var controls = { rotation: 0, latspeed: 0, speed: 0, vx: 0, vz: 0, tx: 0, tz: 0, maxSpeed: 100, acceleration: 100, deceleration: 1000, angularSpeed: 2, wheelRotation : 6, lateral:false};

			function moveRobot(delta) {
				if ( key[7]) controls.lateral = true;
				else controls.lateral = false;
	
				if ( key[0] ) controls.speed = clamp( controls.speed + delta * controls.acceleration, -controls.maxSpeed, controls.maxSpeed );
				if ( key[1] ) controls.speed = clamp( controls.speed - delta * controls.acceleration, -controls.maxSpeed, controls.maxSpeed );
				if ( key[2] ){ 
					if(!controls.lateral)controls.rotation += delta * controls.angularSpeed;
					else controls.latspeed = clamp( controls.latspeed + delta * controls.acceleration, -controls.maxSpeed, controls.maxSpeed );
				}
				if ( key[3] ){
				    if(!controls.lateral)controls.rotation -= delta * controls.angularSpeed;
					else controls.latspeed = clamp( controls.latspeed - delta * controls.acceleration, -controls.maxSpeed, controls.maxSpeed );
				}
				//if ( key[3] || key[2]) controls.speed = clamp( controls.speed + 1 * delta * controls.acceleration, -controls.maxSpeed, controls.maxSpeed );

				// speed decay
				if ( ! ( key[0] || key[1]) ) {
					if ( controls.speed > 0 ) {
						var k = exponentialEaseOut( controls.speed / controls.maxSpeed );
						controls.speed = clamp( controls.speed - k * delta * controls.deceleration, 0, controls.maxSpeed );
					} else {
						var k = exponentialEaseOut( controls.speed / (-controls.maxSpeed) );
						controls.speed = clamp( controls.speed + k * delta * controls.deceleration, -controls.maxSpeed, 0 );
					}
				}
			
				if ( ! ( key[2] || key[3]) ) {
					if ( controls.latspeed > 0 ) {
						var k = exponentialEaseOut( controls.latspeed / controls.maxSpeed );
						controls.latspeed = clamp( controls.latspeed - k * delta * controls.deceleration, 0, controls.maxSpeed );
					} else {
						var k = exponentialEaseOut( controls.latspeed / (-controls.maxSpeed) );
						controls.latspeed = clamp( controls.latspeed + k * delta * controls.deceleration, -controls.maxSpeed, 0 );
					}
				}

				// displacement
				var forwardDelta = controls.speed * delta;
				controls.vx = Math.sin( controls.rotation ) * forwardDelta;
				controls.vz = Math.cos( controls.rotation ) * forwardDelta;

				var sideDelta = controls.latspeed * delta;
				controls.tx = Math.sin( controls.rotation+90*ToRad ) * sideDelta;
				controls.tz = Math.cos( controls.rotation+90*ToRad ) * sideDelta;

				youbot.rotation.y = controls.rotation - 90*ToRad;
				youbot.position.x += controls.vx;
				youbot.position.z += controls.vz;

				youbot.position.x += controls.tx;
				youbot.position.z += controls.tz;

				// wheel animation
				var wSpeed = delta * controls.wheelRotation;
				for(var i=0; i!==4;i++){
					if (key[0]) wheels[i].rotation.z -= wSpeed;
					else if (key[1]) wheels[i].rotation.z += wSpeed;
					else if (key[2]){
						if(!controls.lateral){
							if(i==0 || i==3) wheels[i].rotation.z += wSpeed;
							else wheels[i].rotation.z -= wSpeed;
					    } else {
					    	if(i==1 || i==3) wheels[i].rotation.z += wSpeed;
							else wheels[i].rotation.z -= wSpeed;
					    }
					} else if (key[3]){
						if(!controls.lateral){
							if(i==0 || i==3) wheels[i].rotation.z -= wSpeed;
							else wheels[i].rotation.z += wSpeed;
					    } else {
					    	if(i==1 || i==3) wheels[i].rotation.z -= wSpeed;
							else wheels[i].rotation.z += wSpeed;
					    }
					}
				}

				// camera and sun follow
				if(!camPos.automove)cameraFollow(youbot.position);
				sunLight.position.set(youbot.position.x+120, 200, youbot.position.z+100);
				sunLight.target.position.set(youbot.position.x, 0, youbot.position.z );
			}

			//-----------------------------------------------------
			//  EVENTS
			//-----------------------------------------------------

			function onResize() {
				camera.aspect = window.innerWidth / (window.innerHeight-4);
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight-4 );
			}

			function animate() {
				delta = clock.getDelta();
				render(delta);
				requestAnimationFrame( animate );
				displayInfo();
			}

			function render(delta) {
				moveRobot(delta);
				composer.render(delta);
			}

			function displayInfo() {
				info = "YOUBOT 0.1 alpha<br><br>";
				info += "<i>WSAD, ZSQD or Arrow key to move</i><br>";
				info += "<i>press CTRL for lateral mouvement</i><br><br>";
				info += "Position x:"+ youbot.position.x.toFixed(2) + " y:" + youbot.position.z.toFixed(2);
				document.getElementById('info').innerHTML = info;
			}

			//-----------------------------------------------------
			//  KEYBOARD
			//-----------------------------------------------------

			var key = [0, 0, 0, 0, 0, 0, 0, 0];

			function onKeyDown ( event ) {
				switch ( event.keyCode ) {
				    case 38: case 87: case 90: key[0]=1; break; // up, W, Z
					case 40: case 83:          key[1]=1; break; // down, S
					case 37: case 65: case 81: key[2]=1; break; // left, A, Q
					case 39: case 68:          key[3]=1; break; // right, D
					case 69:                   key[4]=1; break; // E
					case 82:                   key[5]=1; break; // R
					case 32:                   key[6]=1; break; // space
					case 17: case 67:          key[7]=1; break; // ctrl, C
				}
			}

			function onKeyUp ( event ) {
				switch( event.keyCode ) {
					case 38: case 87: case 90: key[0]=0; break; // up, W, Z
					case 40: case 83:          key[1]=0; break; // down, S
					case 37: case 65: case 81: key[2]=0; break; // left, A, Q
					case 39: case 68:          key[3]=0; break; // right, D
					case 69:                   key[4]=0; break; // E
					case 82:                   key[5]=0; break; // R
					case 32:                   key[6]=0; break; // space          
					case 17: case 67:          key[7]=0; break; // ctrl, C
				}
			}

		</script>
	</body>
</html>
