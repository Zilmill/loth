<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>SEA3D webgl</title>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link href="webdemo/css/shader.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="container" class="unselectable"></div>
<div id="title"  class="unselectable"> ... </div>
<div id="options" class="unselectable">
    <div id="pinBtn" class="unselectable"></div>
	<div id="optionsContent" class="unselectable">
	<div class="block">
			<h2>SEA3D model</h2>
			<p class="input"><span id="scaletxt">Scale : 1</span> <input type="range" min="1" max="20" value="1" id="scaleValueInput"/></p>
			<ul class="list" id="modelList">
				<li><a href="#" class="button active" data-value="gauntlet">Gauntlet</a></li>
				<li><a href="#" class="button" data-value="drum">Drum</a></li>
				<li><a href="#" class="button" data-value="dice">Dice</a></li>
				<li><a href="#" class="button" data-value="column">Column</a></li>
				<li><a href="#" class="button" data-value="gyro">Gyro</a></li>
				<li><a href="#" class="button" data-value="youbot">YouBot</a></li>
				<li><a href="#" class="button" data-value="body">Body</a></li>
				<li><a href="#" class="button" data-value="head">Head</a></li>
			</ul>
		</div>
		<div class="block">
			<h2>Material map</h2>
			<p class="input"><span id="blurtxt">Blur : 1</span> <input type="range" min="1" max="50" value="1" id="blurValueInput"/></p>
			<ul class="list" id="materialList">
			</ul>
		</div>
		<div class="block">
			<h2>Normal map</h2>
			<ul class="list" id="normalList">
			</ul>
		</div>
		<div class="block">
			<h2>Normal scale</h2>
			<p class="input"><span>Intensity:</span> <input type="range" min="0" max="200" value="50" id="normalValueInput"/></p>
			<p class="input"><span>Repeat:</span> <input type="range" min="1" max="10" value="1" id="normalRepeatInput"/></p>
		</div>
		<div class="block">
			<h2>Rim lighting</h2>
			<p class="input"><span>Intensity:</span> <input type="range" min="0" max="100" value="0" id="rimValueInput"/></p>		
			<p class="input"><span>Power:</span> <input type="range" min="0 " max="100" value="40" id="rimPowerValueInput"/></p>	
		</div>
		<div class="block">
			<h2>Render options</h2>
			<p><a href="#" id="screenBlendingBtn" class="button">Screen Blending</a> <a href="#" id="antialiasingButton" class="button">Antialiasing</a></p>
		</div>
		<div class="block">	
			<h2>Actions</h2>	
			<p><a href="#" id="fullscreenBtn" class="button">Fullscreen</a> <a href="#" id="snapshotBtn" class="button">Snapshot</a></p>
		</div>
		<div class="block">
		    Code and model by <a href="http://3dflashlo.wordpress.com/" rel="external">Loth</a><br>
		    Shader by <a href="http://www.twitter.com/thespite" rel="external">Jaume SÃ¡nchez</a><br>
		    3d engine THREE.JS by Mr Doob<br>
		    3d format SEA3D <br>
		</div>
	</div>
</div>
<div id="loader" class="unselectable"><img src="webdemo/assets/ajax-loader.gif" alt="Loading..." id="loaderImg"></div>

<script src="webdemo/js/three.min.js"></script>
<script src="webdemo/js/SubdivisionModifier.js"></script>
<script src="webdemo/js/stats.min.js"></script>
<script src="webdemo/js/effects/spherical.js"></script>
<script src="webdemo/js/Detector.js"></script>
<script src="webdemo/js/ImprovedNoise.js"></script>

<script src="webdemo/js/loaders/sea3d/SEA3D.js"></script>
<script src="webdemo/js/loaders/sea3d/SEA3DLoader.js"></script>
<script src="webdemo/js/loaders/sea3d/SEA3DDeflate.js"></script>
<script src="webdemo/js/loaders/sea3d/SEA3DLZMA.js"></script>

<script src="webdemo/js/CameraLoth.js"></script>
<script src="webdemo/js/tweenLite.js"></script>
<script src="webdemo/js/FastBlur.js"></script>
<script src="webdemo/js/ShaderInterface.js"></script>

<script>'use strict'
var container=document.getElementById('container');
var loader=document.getElementById('loader');

var presets=[];
var AssetsFolder = "webdemo/assets/";
var delta, clock;
var hemiLight, pointLight, directionalLight,spotLight;
var renderer,composer, scene,camera,mesh,fov=120,nfov=45,sphereMaterial,material,materialAnim,start=Date.now(), content, cam;
var renderNoise=.04,nRenderNoise=.04,CSSAntialias=false,useScreenBlend=false, optionsPinned=false;
var cubeCamera, envSphere;

var noise=new ImprovedNoise();
var MaxAnistropy;

if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

function init(){
	showLoader(true);
    initInterface();

    clock = new THREE.Clock();

	renderer=new THREE.WebGLRenderer({antialias:true});//,preserveDrawingBuffer:true});
    renderer.physicallyBasedShading = true;
	renderer.gammaOutput = true;
	renderer.gammaInput = true;



	MaxAnistropy = renderer.getMaxAnisotropy();
	container.appendChild(renderer.domElement);
	scene = new THREE.Scene();
	cam = new CameraLoth(container);
	var ambient = new THREE.AmbientLight( 0xFFFFFF);
				scene.add( ambient );
	 /*pointLight = new THREE.PointLight( 0xfeffe6, 1.5, 2000 );
				pointLight.color.setHSL( 0.05, 1, 0.95 );
				pointLight.position.set( 0, 500, 0 );
				scene.add( pointLight );
	directionalLight = new THREE.DirectionalLight( 0xffffff, 1.475 );
				directionalLight.position.set( 100, 100, -100 );
				scene.add( directionalLight );


				hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 1.25 );
				hemiLight.color.setHSL( 0.6, 1, 0.75 );
				hemiLight.groundColor.setHSL( 0.1, 0.8, 0.7 );
				hemiLight.position.y = 500;
				scene.add( hemiLight );*/
	spotLight = new THREE.SpotLight( 0xffffff );
	spotLight.intensity = 1;
	spotLight.position.set(100,200,50);
	//spotLight.target = target;
	/*spotLight.castShadow = true;

	spotLight.shadowCameraNear = 100;
	spotLight.shadowCameraFar = 300;
	spotLight.shadowCameraFov = 75;

	spotLight.shadowMapBias = 0.01;
	spotLight.shadowMapDarkness = 0.7;
	spotLight.shadowMapWidth = 1024;
	spotLight.shadowMapHeight = 1024;*/
	scene.add( spotLight );

	initMaterial();
	var sphere=new THREE.Mesh(new THREE.IcosahedronGeometry(10000,1),sphereMaterial);
	sphere.scale.set(-1,1,1);
	scene.add(sphere);

	///clearMesh();
	///loadCube(addGeometry);

	content = new THREE.Object3D();
	scene.add(content);

	window.addEventListener('resize',onWindowResize,false);
	onWindowResize();
	onThreeChangeView(40, 60, 100);

	
	loadSphere();

	render();
}

function showLoader(show){
	if(show)loader.style.visibility = 'visible';
	else loader.style.visibility = 'hidden';
}

function loadSphere(){
	var loader = new THREE.SEA3D( true );
	loader.onComplete = function( e ) {
		var geo = loader.meshes[0].geometry;
		envSphere = new THREE.Mesh(geo, envMaterial);
		scene.add(envSphere);
		cubeCamera = new THREE.CubeCamera( 0.1, 1.5, 128 );
		cubeCamera.scale.set(-1,1,1);
		cubeCamera.lookAt( new THREE.Vector3(0,0,5))
		scene.add( cubeCamera );
		materialAnim.envMap = cubeCamera.renderTarget;

		loadSeaFile(AssetsFolder + "models/gauntlet.sea", 1);
	}
	loader.load( AssetsFolder + "models/sphere2.sea" );
}

var meshs = [];
var animMeshs = [];
var meshPositions = [];
//var meshBox = [];


function loadSeaFile(file, s){
	showLoader(true);
	clearContent();
	meshs = [];
	animMeshs = [];
	meshPositions = [];
	
	var loader = new THREE.SEA3D( true );

	loader.onComplete = function( e ) {
		showLoader(false);
		var i, j;
		var n=0;
		var linkList ="";
		for (i=0; i !== loader.meshes.length; i++){
			meshs[i] = loader.meshes[i];
		//	meshs[i].geometry.computeVertexNormals();
			//meshs[i].geometry.verticesNeedUpdate=true;
			meshs[i].geometry.buffersNeedUpdate = true;
	//meshs[i].geometry.normalsNeedUpdate=true;
	meshs[i].geometry.uvsNeedUpdate=true;
	/*meshs[i].geometry.computeCentroids();
	meshs[i].geometry.computeFaceNormals();
	meshs[i].geometry.computeVertexNormals();
	meshs[i].geometry.computeMorphNormals();
	meshs[i].geometry.computeTangents();*/
	//meshs[i].geometry.computeBoundingBox();
				//meshBox[i] = meshs[i].geometry.boundingBox;
			
			// original position
			meshPositions[i] = [meshs[i].position.x, meshs[i].position.y, meshs[i].position.z];

			if(meshs[i].bones){
				//meshs[i].name = meshs[i].name+"_a";
				meshs[i].material = materialAnim;
				meshs[i].JITCompile = false;
				meshs[i].interpolationType = THREE.AnimationHandler.LINEAR;
				animMeshs.push(meshs[i]);
				//if(meshs[i].currentAnimation)
				//	meshs[i].play(meshs[i].currentAnimation);
				//meshs[i].play('idle');
			} else {
				meshs[i].material = material;
			}

			if(meshs[i].children.length>0){
				for(j=0; j!== meshs[i].children.length; j++){
					meshs[i].children[j].name = "_"+meshs[i].children[j].name;
				}
			}
			linkList+= meshs[i].name+"<br>";
		}

		document.getElementById('title').innerHTML = linkList;

		for (i=0; i !== meshs.length; i++){
			if(meshs[i].name[0]!=="_"){
				//meshs[i].material = material;
				
				meshs[i].scale.set(s,s,s);
				meshs[i].position.set(meshs[i].position.x*s,meshs[i].position.y*s,meshs[i].position.z*s);
				
				content.add(meshs[i]);
			}
		}
		/*var max=0;
		for (i=0; i !== meshBox.length; i++){
			if(meshBox[i].max.y)max = meshBox[i].max.y;
		}*/

		//document.getElementById('title').innerHTML = max*s*2;
		//onChangeDistance( max*s*2*100);

	}
	loader.load( file );
}

function loadBlob(callback){
	function turbulence(x,y,z){
		var t=-.5;
		for(var f=1;f<=100/12;f*=2){
			t+=Math.abs(noise.noise(f*x,f*y,f*z)/f);
		}
		return t;
	}
	var geometry=new THREE.CubeGeometry(30,30,30,30,30,30);
	for(var j=0;j<geometry.vertices.length;j++){
		var v=geometry.vertices[j];
		var n=v.clone();
		n.normalize();
		v.copy(n);
		v.multiplyScalar(30);
		var f=.05;
		var d=10*noise.noise(f*v.x,f*v.y,f*v.z);v.add(n.multiplyScalar(d));
	}
	material.uniforms.repeat.value.set(1,1);
	callback(geometry);
}

function loadTorusKnot(callback){
	material.uniforms.repeat.value.set(8,1);
	callback(new THREE.TorusKnotGeometry(20,6,200,100,1,3));
}

function clearMesh(){
	clearContent();
	//if(mesh) {scene.remove(mesh);mesh=null;}
}

function addGeometry(geometry){
/*	geometry.verticesNeedUpdate=true;
	geometry.normalsNeedUpdate=true;
	geometry.uvsNeedUpdate=true;
	geometry.computeCentroids();
	geometry.computeFaceNormals();
	geometry.computeVertexNormals();
	geometry.computeMorphNormals();
	geometry.computeTangents();
	mesh=new THREE.Mesh(geometry,material);
	//scene.add(mesh);
	mesh.scale.set(-1,1,1);
	showLoader(false);*/
}

document.getElementById('antialiasingButton').addEventListener('click',function(e){
	CSSAntialias=!CSSAntialias;
	this.classList.toggle('active',CSSAntialias);
	onWindowResize();
	e.preventDefault();
});

function scaleContent(n){
	if(content){
		var obj, i;
		for ( i=0; i !== meshs.length; i++ ) {
			if(meshs[i].name[0]!=="_"){
			    meshs[i].scale.set(n,n,n);
			    meshs[i].position.set(meshPositions[i][0]*n,meshPositions[i][1]*n,meshPositions[i][2]*n);
	        }
		}
	}
}

function clearContent(){
	if(content){
		var obj, i, j;
		for ( i = content.children.length - 1; i >= 0 ; i -- ) {
	    	obj = content.children[ i ];
	        if(obj.children.length > 0) for ( j = obj.children.length - 1; j >= 0 ; j -- ) {obj.remove(obj.children[j]);}
			content.remove(obj);
		}
	}
}

var el=document.getElementById('fullscreenBtn');
if(el){
	var c=document.body;
	el.addEventListener('click',function(e){c.onwebkitfullscreenchange=function(e){c.onwebkitfullscreenchange=function(){};};c.onmozfullscreenchange=function(e){c.onmozfullscreenchange=function(){};};
		if(c.webkitRequestFullScreen)c.webkitRequestFullScreen();
		if(c.mozRequestFullScreen)c.mozRequestFullScreen();
		e.preventDefault();},false);
}
var textureCube;
var envMaterial;

function initMaterial(){
	

	material=new THREE.ShaderMaterial({
		uniforms:{
			tNormal:{type:'t',value:THREE.ImageUtils.loadTexture(AssetsFolder+'normal/243-normal.jpg')},
			tMatCap:{ type:'t',value:THREE.ImageUtils.loadTexture(AssetsFolder+'matcap/jeepster_skinmat2.jpg')},
			time:{ type:'f',value:0},
			bump:{type:'f',value:0},
			noise:{ type:'f',value:.04},
			repeat:{type:'v2',value:new THREE.Vector2(1,1)},
			useNormal:{ type:'f',value:0},
			useRim:{ type:'f',value:0},
			rimPower:{ type:'f',value:2},
			useScreen:{ type:'f',value:0},
			normalScale:{ type:'f',value:.5},
			normalRepeat:{ type:'f',value:1}
		},
		vertexShader:sphere_vertexShader,
		fragmentShader:sphere_fragmentShader,
		wrapping:THREE.ClampToEdgeWrapping,
		shading:THREE.SmoothShading//,
		//side:THREE.DoubleSide
	});
	material.uniforms.tMatCap.value.wrapS=material.uniforms.tMatCap.value.wrapT=THREE.ClampToEdgeWrapping;
	material.uniforms.tNormal.value.wrapS=material.uniforms.tNormal.value.wrapT=THREE.RepeatWrapping;


	envMaterial = new THREE.MeshBasicMaterial( {} );
	envMaterial.map = material.uniforms.tMatCap.value;

	materialAnim =  new THREE.MeshPhongMaterial( {
		color: 0xffFFFF, 
		ambient: 0xFFFFFF, 
		shininess:50, 
		specular:0xffFFFF,
		reflectivity:1,  
		envMap:textureCube, 
	    combine: THREE.MixOperation,
		skinning:true,
		normalMap:material.uniforms.tNormal.value,
		normalScale:{x:0,y:0},
		wrapping:THREE.ClampToEdgeWrapping,
		shading:THREE.SmoothShading
	} ) 

	materialAnim.normalMap.repeat.set( 1, 1 );
	materialAnim.normalMap.wrapS=materialAnim.normalMap.wrapT=THREE.RepeatWrapping;

	sphereMaterial=new THREE.ShaderMaterial({
		uniforms:{
			resolution:{ type:'v2',value:new THREE.Vector2(0,0)},
			noise:{ type:'f',value:.04}
		},
		vertexShader:sphere_vs,
		fragmentShader:sphere_fs,
		side:THREE.BackSide
	});
}

function setNoise(n){
	material.uniforms.noise.value=sphereMaterial.uniforms.noise.value=n;
}

function onWindowResize(){
	var s=CSSAntialias?2:1;
	setCameraSize(s*window.innerWidth, s*window.innerHeight);
	renderer.setSize(s*window.innerWidth,s*window.innerHeight);
	sphereMaterial.uniforms.resolution.value.set(s*window.innerWidth,s*window.innerHeight);
}


function render(){
	
	spotLight.position.copy(camera.position);
	spotLight.lookAt(center);

	delta = clock.getDelta();
	THREE.AnimationHandler.update( delta );

	renderNoise+=(nRenderNoise-renderNoise)*.2;
	setNoise(renderNoise);

	renderer.render(scene,camera);

	if(envSphere){
		envSphere.rotation.y = (-camPos.horizontal)*ToRad;
		envSphere.rotation.z = (-camPos.vertical-90)*ToRad;
		envSphere.visible = true;
		cubeCamera.updateCubeMap( renderer, scene );
		envSphere.visible = false;
	}

	requestAnimationFrame(render);
}

window.addEventListener('load',init);
</script>
</body>
</html>
